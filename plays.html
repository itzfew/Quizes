<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz Game</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
        }
        select, input, button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
        }
        .question-container {
            margin-top: 20px;
            border-top: 2px solid #ccc;
            padding-top: 10px;
        }
        .question {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .question h3 {
            margin: 0;
            font-size: 18px;
        }
        .options {
            margin-top: 10px;
        }
        .options label {
            display: block;
        }
        .result-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #e9e9e9;
            border-radius: 8px;
        }
        .result-container h2 {
            font-size: 24px;
        }
        .explanation {
            margin-top: 10px;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
        }
        .explanation.correct {
            background-color: #d4edda;
        }
        .explanation.incorrect {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>

    <h1>Math Quiz Game</h1>

    <div>
        <label for="paper-title">Choose Exam Paper:</label>
        <select id="paper-title"></select>
    </div>

    <div>
        <label for="num-questions">Enter number of questions to display:</label>
        <input type="number" id="num-questions" min="1" max="10">
    </div>

    <button id="start-btn">Start Quiz</button>
    <button id="submit-btn" style="display:none;">Submit Quiz</button>

    <div class="question-container" id="question-container"></div>
    <div class="result-container" id="result-container" style="display:none;"></div>

    <script>
        const examsDataUrl = 'https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/exams.json';
        let papers = [];
        let currentQuestions = [];
        let userAnswers = [];

        // Fetch exams data
        fetch(examsDataUrl)
            .then(response => response.json())
            .then(data => {
                papers = data;
                populatePaperTitles();
            });

        function populatePaperTitles() {
            const paperSelect = document.getElementById('paper-title');
            papers.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.title;
                option.textContent = exam.title;
                paperSelect.appendChild(option);
            });
        }

        document.getElementById('start-btn').addEventListener('click', startQuiz);
        document.getElementById('submit-btn').addEventListener('click', submitQuiz);

        function startQuiz() {
            const selectedTitle = document.getElementById('paper-title').value;
            const numQuestions = parseInt(document.getElementById('num-questions').value);

            if (!selectedTitle || isNaN(numQuestions) || numQuestions <= 0) {
                alert("Please select a paper and enter a valid number of questions.");
                return;
            }

            const selectedPapers = papers.find(exam => exam.title === selectedTitle).papers;

            const questions = [];

            // Loop through each paper and aggregate questions
            selectedPapers.forEach(paper => {
                const paperUrl = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${paper.metaId}.json`;
                fetch(paperUrl)
                    .then(response => response.json())
                    .then(data => {
                        // Push questions from all papers into one array
                        data[0].questions.forEach(question => {
                            question.paperTitle = paper.title; // Attach paper title for later use
                            questions.push(question);
                        });

                        // After processing all the papers, shuffle questions
                        if (questions.length >= numQuestions) {
                            const shuffledQuestions = getRandomQuestions(questions, numQuestions);
                            currentQuestions = shuffledQuestions;
                            displayQuestions(currentQuestions);
                            document.getElementById('submit-btn').style.display = 'inline-block';
                        }
                    });
            });
        }

        // Function to shuffle and select random questions
        function getRandomQuestions(allQuestions, numQuestions) {
            return allQuestions.sort(() => Math.random() - Math.random()).slice(0, numQuestions);
        }

        function displayQuestions(questions) {
            const container = document.getElementById('question-container');
            container.innerHTML = ''; // Clear previous questions

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');

                const questionTitle = document.createElement('h3');
                questionTitle.innerHTML = `${index + 1}. ${question.content} <small> (From: ${question.paperTitle}) </small>`;
                questionDiv.appendChild(questionTitle);

                const optionsDiv = document.createElement('div');
                optionsDiv.classList.add('options');

                // Check if the question has options
                if (question.options && question.options.length > 0) {
                    // If options are available, display them as A, B, C, D, etc.
                    question.options.forEach((option, optionIndex) => {
                        const optionInput = document.createElement('input');
                        optionInput.type = 'radio';
                        optionInput.name = `question${index}`;
                        optionInput.value = String.fromCharCode(65 + optionIndex); // A, B, C, D, etc.
                        const optionLabel = document.createElement('label');
                        optionLabel.innerHTML = `${String.fromCharCode(65 + optionIndex)}. ${option.content}`;
                        optionsDiv.appendChild(optionInput);
                        optionsDiv.appendChild(optionLabel);
                    });
                } else {
                    // If no options, create a text input for the integer answer
                    const inputField = document.createElement('input');
                    inputField.type = 'number';
                    inputField.name = `question${index}`;
                    inputField.placeholder = 'Enter your answer';
                    optionsDiv.appendChild(inputField);
                }

                questionDiv.appendChild(optionsDiv);
                container.appendChild(questionDiv);
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub, container]);
        }

        function submitQuiz() {
            let totalScore = 0;
            let totalNegativeMarks = 0;
            userAnswers = [];

            currentQuestions.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                if (selectedOption) {
                    const answer = selectedOption.value;
                    userAnswers.push(answer);

                    // Check if the selected option matches the correct answer
                    if (answer === question.correct_options) {
                        totalScore += question.marks; // Add marks for correct answer
                    } else {
                        totalNegativeMarks += question.negMarks; // Deduct negative marks for wrong answer
                    }
                } else {
                    // If there is no option selected, check for text input field answer
                    const inputField = document.querySelector(`input[name="question${index}"]`);
                    const userAnswer = inputField ? parseInt(inputField.value.trim()) : '';
                    if (userAnswer === question.answer) {  // Updated to check against 'answer' for input questions
                        totalScore += question.marks;
                    } else if (userAnswer !== '') {
                        totalNegativeMarks += question.negMarks; // Deduct negative marks for incorrect answer
                    }
                    userAnswers.push(userAnswer);
                }
            });

            const finalScore = totalScore - totalNegativeMarks; // Calculate the final score
            showResults(finalScore);
        }

        function showResults(finalScore) {
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            let resultText = `<h2>Your Final Score: ${finalScore} / ${currentQuestions.length * 4}</h2>`; // Assuming max marks per question is 4
            currentQuestions.forEach((question, index) => {
                const correct = userAnswers[index] === (question.answer || question.correct_options); // Updated check
                resultText += `
                    <div class="explanation ${correct ? 'correct' : 'incorrect'}">
                        <strong>Q${index + 1}: ${question.content}</strong><br>
                        <span>Your answer: ${userAnswers[index] || 'No answer'}</span><br>
                        <span>Correct answer: ${question.answer || question.correct_options}</span><br>
                        <span>Marks for this question: ${question.marks}</span><br>
                        <span>Negative Marks for wrong answer: ${question.negMarks}</span><br>
                        <span>Explanation: ${question.explanation || 'No explanation available'}</span><br>
                        <small>Source: ${question.paperTitle || 'Not Provided'}</small>
                    </div>
                `;
            });

            resultContainer.innerHTML = resultText;
        }
    </script>
</body>
</html>
