<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEET PYQ Practice</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>NEET PYQ Practice Game</h1>

  <div id="setup">
    <h2>Enter number of questions:</h2>
    <input type="number" id="numQuestions" min="3" step="1" />
    <button onclick="startQuiz()">Start</button>
  </div>

  <div id="quiz" class="hidden">
    <div id="navigation"></div>
    <div id="source"></div>
    <div id="question-box"></div>
    <div class="controls">
      <button onclick="prevQuestion()">Back</button>
      <button onclick="checkAnswer()">Check Answer</button>
      <button onclick="nextQuestion()">Next</button>
    </div>
    <div id="result"></div>
    <div id="detailed-result" class="hidden"></div>
  </div>

  <script>
    const subjects = ['biology', 'chemistry', 'physics'];
    const metaIds = [
      { id: "cbfbed57-d7d8-5a07-9957-478e4cb62f17", title: "NEET 2023" },
      { id: "2ff56f11-0061-566e-aeca-9cc14246e8fb", title: "NEET 2021" },
      { id: "27ba990b-5085-5196-87dd-9727f95fc228", title: "NEET 2020 Phase 1" },
      { id: "c3ae87e9-4094-514a-b2a4-b6e98b1d7ec3", title: "NEET 2019" }
    ];

    let allQuestions = [], quizQuestions = [], currentIndex = 0, answerCache = {}, visitCache = {};

    async function startQuiz() {
      const count = parseInt(document.getElementById('numQuestions').value);
      if (!count || count < 3) return alert('Enter at least 3 questions.');

      document.getElementById('setup').classList.add('hidden');
      document.getElementById('quiz').classList.remove('hidden');

      for (const meta of metaIds) {
        const url = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${meta.id}.json`;
        const res = await fetch(url);
        const data = await res.json();
        allQuestions.push(...data.flatMap(group =>
          group.questions.map(q => ({ ...q, source: meta.title }))
        ));
      }

      const perSubject = Math.floor(count / 3);
      const remainder = count % 3;
      const subjectDist = [perSubject + (remainder >= 1), perSubject + (remainder >= 2), perSubject];

      for (let i = 0; i < 3; i++) {
        const subjectQs = allQuestions.filter(q => q.subject === subjects[i]);
        const picked = subjectQs.sort(() => 0.5 - Math.random()).slice(0, subjectDist[i]);
        quizQuestions.push(...picked);
      }

      quizQuestions = quizQuestions.map((q, i) => ({ ...q, number: i + 1 }));
      generateNav();
      loadQuestion(0);
    }

    function generateNav() {
      const nav = document.getElementById('navigation');
      nav.innerHTML = '';
      quizQuestions.forEach((_, i) => {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.onclick = () => loadQuestion(i);
        btn.id = `nav-${i}`;
        nav.appendChild(btn);
      });
    }

    function loadQuestion(index) {
      currentIndex = index;
      const q = quizQuestions[index];
      document.getElementById('source').textContent = `Subject: ${q.subject.toUpperCase()} | Source: ${q.source}`;
      visitCache[q.question_id] = true;

      let html = `<h3>${renderMath(q.content)}</h3><ul>`;
      q.options.forEach((opt, i) => {
        html += `<li class="option" data-id="${opt.identifier}" onclick="selectOption('${opt.identifier}')">${String.fromCharCode(65 + i)}. ${renderMath(opt.content)}</li>`;
      });
      html += '</ul>';
      document.getElementById('question-box').innerHTML = html;
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

      const saved = localStorage.getItem(`q-${q.question_id}`);
      if (saved) selectOption(saved);
      updateNavColors(q.question_id, currentIndex);
      document.querySelector(".controls button:nth-child(2)").disabled = false;
    }

    function selectOption(id) {
      const options = document.querySelectorAll('.option');
      options.forEach(o => o.classList.remove('selected'));
      const el = [...options].find(o => o.dataset.id === id);
      if (el) el.classList.add('selected');
      localStorage.setItem(`q-${quizQuestions[currentIndex].question_id}`, id);
    }

    function checkAnswer() {
      const q = quizQuestions[currentIndex];
      const selected = document.querySelector('.option.selected');
      const correctIds = q.correct_options;
      const navBtn = document.getElementById(`nav-${currentIndex}`);
      const opts = document.querySelectorAll('.option');
      let status;

      opts.forEach(opt => {
        const id = opt.dataset.id;
        if (correctIds.includes(id)) opt.classList.add('correct');
        if (selected && id === selected.dataset.id) {
          if (correctIds.includes(id)) {
            opt.classList.add('correct');
            status = 'correct';
          } else {
            opt.classList.add('incorrect');
            status = 'incorrect';
          }
        }
      });

      if (!selected) {
        status = 'missed';
        opts.forEach(opt => {
          if (correctIds.includes(opt.dataset.id)) opt.classList.add('correct');
        });
      }

      answerCache[q.question_id] = (status === 'correct') ? 4 : (status === 'incorrect') ? -1 : 0;

      updateNavColors(q.question_id, currentIndex, status);

      const explanation = q.explanation || 'No explanation available.';
      const explanationHTML = `
        <div class="collapsible">
          <div class="collapse-header" onclick="toggleCollapse(this)">
            <span>Show Explanation</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="collapse-content">${explanation}</div>
        </div>`;
      document.getElementById('question-box').insertAdjacentHTML('beforeend', explanationHTML);
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

      calculateScore();
      document.querySelector(".controls button:nth-child(2)").disabled = true;
    }

    function updateNavColors(qid, idx, status = null) {
      const btn = document.getElementById(`nav-${idx}`);
      btn.classList.add('visited');
      btn.classList.remove('nav-correct', 'nav-incorrect', 'nav-missed');

      const selected = localStorage.getItem(`q-${qid}`);
      if (status === 'correct') btn.classList.add('nav-correct');
      else if (status === 'incorrect') btn.classList.add('nav-incorrect');
      else if (!selected && visitCache[qid]) btn.classList.add('nav-missed');
    }

    function renderMath(str) {
      return str.replace(/\$\$(.*?)\$\$/g, (_, eq) => `<span class="mathjax">$$${eq}$$</span>`);
    }

    function toggleCollapse(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('i');
      const span = header.querySelector('span');
      if (content.style.display === 'block') {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        span.textContent = 'Show Explanation';
      } else {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        span.textContent = 'Hide Explanation';
      }
    }

    function nextQuestion() {
      if (currentIndex < quizQuestions.length - 1) loadQuestion(currentIndex + 1);
      else showResult();
    }

    function prevQuestion() {
      if (currentIndex > 0) loadQuestion(currentIndex - 1);
    }

    function calculateScore() {
      const total = quizQuestions.reduce((sum, q) => sum + (answerCache[q.question_id] || 0), 0);
      const maxScore = quizQuestions.length * 4;
      document.getElementById('result').textContent = `Score: ${total} / ${maxScore}`;
    }

    function showResult() {
      calculateScore();
      let correct = 0, incorrect = 0, missed = 0;

      quizQuestions.forEach(q => {
        const score = answerCache[q.question_id];
        if (score === 4) correct++;
        else if (score === -1) incorrect++;
        else missed++;
      });

      const maxScore = quizQuestions.length * 4;
      const resultDiv = document.getElementById('detailed-result');
      resultDiv.innerHTML = `
        <h3>Detailed Result</h3>
        <p>‚úÖ Correct: ${correct}</p>
        <p>‚ùå Incorrect: ${incorrect}</p>
        <p>‚ö†Ô∏è Missed: ${missed}</p>
        <p>üíØ Final Score: ${correct * 4 - incorrect} / ${maxScore}</p>
        <hr/>
        <h4>Missed Questions (Highlighted First)</h4>
        <ul>
          ${quizQuestions
            .sort((a, b) => (answerCache[a.question_id] || 0) - (answerCache[b.question_id] || 0))
            .map(q => {
              const score = answerCache[q.question_id];
              const color = score === 4 ? 'green' : score === -1 ? 'red' : 'orange';
              return `<li style="color:${color}">Q${q.number} - ${score === 0 ? 'Missed' : score === 4 ? 'Correct' : 'Incorrect'}</li>`;
            }).join('')}
        </ul>`;
      resultDiv.classList.remove('hidden');
      alert('Quiz Complete!');
    }
  </script>
</body>
</html>
