<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Question Paper Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    #controls {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    #questionsArea {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      column-count: 2;
      column-gap: 30px;
    }
    .question-card {
      margin-bottom: 25px;
      break-inside: avoid;
      page-break-inside: avoid;
    }
    .question-text {
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .options-container {
      margin-left: 15px;
    }
    .option {
      margin-bottom: 8px;
      padding: 8px 10px;
      background: #f0f4f8;
      border-radius: 5px;
      font-size: 13px;
      line-height: 1.4;
      break-inside: avoid;
    }
    input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-width: 200px;
    }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #1565c0;
    }
    button:disabled {
      background: #90caf9;
      cursor: not-allowed;
    }
    .meta-info {
      font-size: 12px;
      color: #607d8b;
      margin-bottom: 5px;
      display: flex;
      gap: 15px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    @media (max-width: 768px) {
      #questionsArea {
        column-count: 1;
      }
      #controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    @media print {
      #controls {
        display: none;
      }
      body {
        background: white;
        padding: 0;
      }
      #questionsArea {
        box-shadow: none;
        padding: 0;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="controls">
    <input type="number" id="numQuestions" placeholder="Number of questions" min="1" value="10">
    <button id="generateBtn" onclick="generateQuestions()">Generate Question Paper</button>
    <button id="pdfBtn" onclick="downloadPDF()" disabled>Download PDF</button>
    <button onclick="window.print()">Print Question Paper</button>
  </div>

  <div id="questionsArea">
    <div class="loading">Select number of questions and click "Generate"</div>
  </div>
</div>

<script>
// Global variables
const { jsPDF } = window.jspdf;
let questionData = [];
let currentQuestions = [];
let pdfReady = false;

// Fetch questions from the provided URL
async function fetchQuestions() {
  try {
    document.getElementById('questionsArea').innerHTML = '<div class="loading">Loading questions...</div>';
    const res = await fetch('https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/014be169-4893-5d08-a744-5ca0749e3c20.json');
    const json = await res.json();
    questionData = json[0].questions;
    return true;
  } catch (error) {
    console.error('Error fetching questions:', error);
    document.getElementById('questionsArea').innerHTML = '<div class="loading">Error loading questions. Please try again.</div>';
    return false;
  }
}

// Render questions based on user input
async function generateQuestions() {
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.textContent = 'Generating...';
  
  // Fetch questions if not already loaded
  if (questionData.length === 0) {
    const success = await fetchQuestions();
    if (!success) {
      btn.disabled = false;
      btn.textContent = 'Generate Question Paper';
      return;
    }
  }

  const n = parseInt(document.getElementById('numQuestions').value) || 10;
  currentQuestions = getRandomQuestions(n);
  
  renderQuestions(currentQuestions);
  
  // Typeset MathJax to render any math formulas
  if (typeof MathJax !== 'undefined') {
    await MathJax.typesetPromise();
  }
  
  pdfReady = true;
  document.getElementById('pdfBtn').disabled = false;
  btn.disabled = false;
  btn.textContent = 'Generate Question Paper';
}

// Get random questions from the pool
function getRandomQuestions(n) {
  // Create a copy of the array
  const shuffled = [...questionData];
  // Fisher-Yates shuffle
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled.slice(0, n);
}

// Render questions to the DOM
function renderQuestions(questions) {
  const container = document.getElementById('questionsArea');
  if (questions.length === 0) {
    container.innerHTML = '<div class="loading">No questions available</div>';
    return;
  }

  container.innerHTML = '';
  
  questions.forEach((q, idx) => {
    const card = document.createElement('div');
    card.className = 'question-card';

    // Add metadata
    const meta = document.createElement('div');
    meta.className = 'meta-info';
    meta.innerHTML = `
      <span>Subject: ${q.subject || 'General'}</span>
      <span>Chapter: ${q.chapter || 'N/A'}</span>
      <span>Marks: ${q.marks || 1}</span>
    `;
    card.appendChild(meta);

    // Add question text
    const question = document.createElement('div');
    question.className = 'question-text';
    question.innerHTML = `<b>Q${idx + 1}.</b> ${formatContent(q.content)}`;
    card.appendChild(question);

    // Add options
    if (q.options && q.options.length > 0) {
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'options-container';
      
      q.options.forEach(opt => {
        const optDiv = document.createElement('div');
        optDiv.className = 'option';
        optDiv.innerHTML = `<b>${opt.identifier}.</b> ${formatContent(opt.content)}`;
        optionsDiv.appendChild(optDiv);
      });
      
      card.appendChild(optionsDiv);
    }

    container.appendChild(card);
  });
}

// Format content (handle HTML/MathJax)
function formatContent(content) {
  if (!content) return '';
  
  // Replace newlines with <br>
  content = content.replace(/\n/g, '<br>');
  
  // If content contains LaTeX (simple detection)
  if (content.includes('\\(') || content.includes('\\[')) {
    return content;
  }
  
  // If content contains HTML tags
  if (/<[a-z][\s\S]*>/i.test(content)) {
    return content;
  }
  
  // Default: escape HTML and keep as plain text
  return content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Generate PDF from rendered HTML
async function downloadPDF() {
  if (!pdfReady) return;
  
  const btn = document.getElementById('pdfBtn');
  btn.disabled = true;
  btn.textContent = 'Generating PDF...';
  
  // Create a temporary container for PDF generation
  const tempContainer = document.createElement('div');
  tempContainer.style.width = '210mm'; // A4 width
  tempContainer.style.padding = '20mm';
  tempContainer.style.background = 'white';
  tempContainer.style.boxSizing = 'border-box';
  
  // Clone all question cards
  const cards = document.querySelectorAll('.question-card');
  cards.forEach(card => {
    tempContainer.appendChild(card.cloneNode(true));
  });
  
  // Add to body but keep invisible
  tempContainer.style.position = 'absolute';
  tempContainer.style.left = '-9999px';
  document.body.appendChild(tempContainer);
  
  // Create PDF
  const pdf = new jsPDF('p', 'mm', 'a4');
  let position = 0;
  const pageHeight = pdf.internal.pageSize.getHeight();
  
  try {
    // Process in chunks to avoid memory issues
    for (let i = 0; i < cards.length; i++) {
      const card = tempContainer.children[i];
      const canvas = await html2canvas(card, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth() - 40; // 20mm margins
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      
      // Check if we need a new page
      if (position + pdfHeight > pageHeight - 20 && position !== 0) {
        pdf.addPage();
        position = 0;
      }
      
      pdf.addImage(imgData, 'PNG', 20, position + 20, pdfWidth, pdfHeight);
      position += pdfHeight + 10;
    }
    
    pdf.save('question-paper.pdf');
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF. Please check console for details.');
  } finally {
    // Clean up
    document.body.removeChild(tempContainer);
    btn.disabled = false;
    btn.textContent = 'Download PDF';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Load questions automatically
  fetchQuestions();
  
  // Enable generate button when number is entered
  document.getElementById('numQuestions').addEventListener('input', function() {
    document.getElementById('generateBtn').disabled = !this.value || parseInt(this.value) < 1;
  });
});
</script>
</body>
</html>
