<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>PDF Generator - NEET PYQs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/paper-css@0.3.0/paper.min.css">
    <style>
      @page { size: A4; margin: 10mm }
      @media print {
        .footer { page-break-after: always; }
        .footer:last-child { page-break-after: avoid; }
        .noprint { display: none !important; }
        table {
          max-width: 100% !important;
          width: 100% !important;
        }
        td, th {
          overflow-wrap: break-word !important;
          word-break: break-all !important;
          white-space: normal !important;
          max-width: 120px !important;
          padding: 3px !important;
          font-size: 9pt !important;
        }
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
      }
      .question {
        padding: 5px;
        font-size: 10pt;
        line-height: 1.3;
        margin-bottom: 8px;
      }
      .loader .spinner {
        border: 12px solid #f3f3f3;
        border-top: 12px solid #3498db;
        border-radius: 50%;
        margin: auto;
        width: 80px;
        height: 80px;
        animation: spin 1.5s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #printDiv {
        display: none;
        justify-content: center;
        margin: 20px 0;
      }
      #printBtn {
        width: 250px;
        padding: 10px;
        background: #28a745;
        color: white;
        font-size: 16px;
        font-weight: bold;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }
      .sheet .content .column {
        text-align: justify;
        font-size: 10pt;
        line-height: 1.3;
        max-width: 50%;
      }
      .sheet .content .column blockquote {
        background: #f5f5f5;
        padding: 6px;
        margin: 4px 10px;
        border-left: 2px solid #ddd;
      }
      .sheet .header {
        text-align: center;
        font-size: 14pt;
        padding: 10px 0;
      }
      .sheet .header .contact {
        float: right;
        font-size: 10pt;
      }
      .sheet .header .logo {
        float: left;
      }
      .sheet .header hr, .sheet .footer hr {
        width: 95%;
        margin: 8px auto;
      }
      .sheet .footer span {
        position: absolute;
        bottom: 8px;
        right: 10px;
        font-size: 9pt;
      }
      .page_template {
        display: none;
      }
      table {
        table-layout: fixed;
        border-collapse: collapse;
        border: 1px solid #333;
        width: 100%;
        max-width: 100%;
        font-size: 9pt;
        margin: 4px 0;
      }
      th, td {
        border: 1px solid #333;
        padding: 3px;
        text-align: left;
        vertical-align: top;
        overflow-wrap: break-word;
        word-break: break-all;
        white-space: normal;
        max-width: 120px;
        min-width: 15px;
        font-size: 9pt;
      }
      td:nth-child(1), td:nth-child(3) {
        width: 5%;
        min-width: 15px;
      }
      td:nth-child(2), td:nth-child(4) {
        width: 45%;
        max-width: 120px;
      }
      .question table, .question table * {
        width: 100% !important;
        max-width: 100% !important;
        table-layout: fixed !important;
      }
      .question table colgroup, .question table col {
        width: auto !important;
        min-width: 0 !important;
      }
      .content {
        padding: 8px;
        background: linear-gradient(#000, #000) no-repeat center/0.1px 98%;
        border-bottom: 1px solid #333;
      }
      .content img {
        max-width: 85%;
        height: auto;
        display: block;
        margin: 4px auto;
      }
      .error-message {
        color: red;
        text-align: center;
        margin: 20px;
        font-size: 12pt;
      }
      /* Prevent MathJax line breaks and ensure inline equations are rendered smoothly */
      .mathjax-inline {
        white-space: nowrap;
        display: inline-block;
        font-size: 1.1em;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src='https://www.neetprep.com/jquery.columnizer.min.js'></script>
    <script async src='https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js'></script>
    <script>
      $(function() {
        var content_height = 900;
        var page = 1;
        var examTitle = "NEET PYQs";

        // Meta IDs and titles
        const metaIds = [
          { id: "3c48616f-298a-5f69-91d2-bcd59444c455", title: "NEET 2023 Manipur" },
          { id: "cbfbed57-d7d8-5a07-9957-478e4cb62f17", title: "NEET 2023" },
          { id: "8dd253c6-09a8-5875-b127-a0c00a165a1b", title: "NEET 2022 Phase 2" },
          { id: "c7fb1fc7-cb24-58d1-99f5-4ced0111082d", title: "NEET 2022 Phase 1" },
          { id: "2ff56f11-0061-566e-aeca-9cc14246e8fb", title: "NEET 2021" },
          { id: "27ba990b-5085-5196-87dd-9727f95fc228", title: "NEET 2020 Phase 1" },
          { id: "c3ae87e9-4094-514a-b2a4-b6e98b1d7ec3", title: "NEET 2019" },
          { id: "ce68b80b-fff0-5db8-8d6a-668d729d487a", title: "NEET 2018" },
          { id: "57222784-be0a-5653-930c-8ac44c689e21", title: "NEET 2017" },
          { id: "80eef6f1-3522-515e-b73d-339d85018141", title: "NEET 2016 Phase 2" },
          { id: "938f3847-eb62-525b-b1b0-02ee459e81f8", title: "NEET 2016 Phase 1" },
          { id: "47778809-6194-57b2-868a-e4fedb6e9f3a", title: "AIPMT 2015" },
          { id: "8713af28-1c8f-53cc-9230-bcc6ea3843c9", title: "AIPMT 2015 Cancelled Paper" },
          { id: "8756d5f2-5c2a-506e-af0c-0198c9fc2187", title: "AIPMT 2014" },
          { id: "1c4dc710-3261-5cd5-bb3e-ee281740f624", title: "NEET 2013 (Karnataka)" },
          { id: "48007b77-2c75-5367-9ca7-98b53cceaca8", title: "NEET 2013" },
          { id: "068d67b3-bca5-5dc4-af63-9dbf0f7ce7be", title: "AIPMT 2012 Mains" },
          { id: "9bdb3f61-14cf-57d2-9324-5465da11de4d", title: "AIPMT 2012 Prelims" },
          { id: "a3afa98f-582a-5a4c-ada4-d17ad73090be", title: "AIPMT 2011 Mains" },
          { id: "dfc116dc-cf26-5489-aa89-99266a7512a9", title: "AIPMT 2011 Prelims" },
          { id: "da3ac707-aeab-5c4d-807e-6a0705098929", title: "AIPMT 2010 Mains" },
          { id: "b91bcb0a-a1ae-550b-a078-b25fcbd422ee", title: "AIPMT 2010 Prelims" },
          { id: "b0e9a6d4-f603-58b1-9723-66c27d5c959b", title: "AIPMT 2009" },
          { id: "4432d9cf-5356-5982-b930-2f9d9d752fef", title: "AIPMT 2008" },
          { id: "4076c9ee-750f-5bd9-a821-c59bed8ab4fd", title: "AIPMT 2007" },
          { id: "084ad628-cb2a-5390-80d1-ccc658633f19", title: "AIPMT 2006" },
          { id: "6c2de931-ef9f-52bc-af22-bebe0c0ff520", title: "AIPMT 2005" },
          { id: "e537df27-eaab-55a1-9a01-c84409f04935", title: "AIPMT 2004" },
          { id: "9f3fa1a4-1199-5b24-b381-d7df26102489", title: "AIPMT 2003" },
          { id: "3dbc2670-9688-5143-ae78-7fb777e3eaf6", title: "AIPMT 2002" },
          { id: "762be6c6-de8f-548d-859d-3a2343237947", title: "AIPMT 2001" },
          { id: "d594604a-f9e6-5929-b3bf-b720a34fabe3", title: "AIPMT 2000" }
        ];

        // Fallback content
        var fallbackContent = [
          {
            questions: [
              {
                content: "What is the SI unit of force? (A) Newton (B) Joule (C) Watt (D) Pascal",
                options: [
                  { content: "Newton" },
                  { content: "Joule" },
                  { content: "Watt" },
                  { content: "Pascal" }
                ]
              },
              {
                content: "Calculate the force: $F = ma$ where $m = 2\\,\\text{kg}$, $a = 3\\,\\text{m/s}^2$.",
                options: [
                  { content: "$6\\,\\text{N}$" },
                  { content: "$12\\,\\text{N}$" },
                  { content: "$9\\,\\text{N}$" },
                  { content: "$3\\,\\text{N}$" }
                ]
              }
            ]
          }
        ];

        // Parse query parameters
        function getQueryParam(param) {
          var urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(param);
        }

        var selectedMetaId = getQueryParam('metaid') || metaIds[0].id;
        var totalQuestions = parseInt(getQueryParam('total')) || 0;
        var selectedMeta = metaIds.find(meta => meta.id === selectedMetaId) || metaIds[0];
        examTitle = totalQuestions === 180 ? "NEET Mixed Test" : selectedMeta.title;

        // Update header with exam title
        $('.page_template .header').html(`
          <img class="logo" src="https://www.neetprep.com/assets/img/logo.png" width="90" height="22">
          ${examTitle}
          <span class="contact">Contact: 8527521718</span>
          <hr>
        `);

        function renderMathJax(content) {
          if (!content) return "";
          return content
            .replace(/\$\$(.*?)\$\$/g, (match, p1) => `<span class="mathjax-block">\\[${p1}\\]</span>`)
            .replace(/\$(.*?)\$/g, (match, p1) => `<span class="mathjax-inline">\\(${p1}\\)</span>`);
        }

        function typesetMathJax() {
          if (window.MathJax) {
            MathJax.typesetPromise()
              .then(() => console.log("MathJax typesetting completed"))
              .catch(err => console.error("MathJax typesetting error:", err));
          } else {
            console.warn("MathJax not loaded");
          }
        }

        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        }

        function renderQuestions(questions) {
          console.log("Rendering questions:", questions.length);
          var newsletterContent = $('#newsletterContent');
          newsletterContent.empty();

          if (questions.length === 0) {
            console.warn("No questions to render");
            newsletterContent.append('<div class="error-message">No questions available. Please try another meta ID or check JSON availability.</div>');
            return;
          }

          questions.forEach(function(q, index) {
            if (!q || !q.content) {
              console.warn("Invalid question at index", index, q);
              return;
            }
            var questionContent = renderMathJax(q.content);
            var questionHtml = '<div class="dontsplit question">' +
              '<span class="questionId"><b>' + (index + 1) + '.</b></span> ' +
              '<p style="display:inline">' + questionContent + '</p>';

            if (q.options && Array.isArray(q.options) && q.options.length > 0) {
              questionHtml += '<table><tbody>';
              for (var i = 0; i < q.options.length; i += 2) {
                questionHtml += '<tr>' +
                  '<td>' + (i + 1) + '.</td>' +
                  '<td>' + renderMathJax(q.options[i]?.content || "") + '</td>';
                if (i + 1 < q.options.length) {
                  questionHtml += '<td>' + (i + 2) + '.</td>' +
                    '<td>' + renderMathJax(q.options[i + 1]?.content || "") + '</td>';
                }
                questionHtml += '</tr>';
              }
              questionHtml += '</tbody></table>';
            }

            questionHtml += '<br>';
            newsletterContent.append(questionHtml);
          });

          typesetMathJax();
        }

        function adjustTableWidths() {
          $('.question table').each(function() {
            var $table = $(this);
            var parentWidth = $table.parent().width();
            $table.css({
              'width': '100%',
              'max-width': parentWidth + 'px',
              'table-layout': 'fixed'
            });
            $table.find('col, colgroup').css({
              'width': 'auto',
              'min-width': '0'
            });
            $table.find('th, td').css({
              'max-width': '120px',
              'padding': '3px',
              'font-size': '9pt',
              'overflow-wrap': 'break-word',
              'word-break': 'break-all',
              'white-space': 'normal'
            });
            if ($table.width() > parentWidth) {
              console.log("Adjusted table width from", $table.width(), "to parent:", parentWidth);
              $table.css('width', '100%');
            }
            $table.find('td').each(function() {
              var $td = $(this);
              if ($td.width() > 120) {
                $td.css('max-width', '120px');
                console.log("Compressed table cell width:", $td.width());
              }
            });
          });
        }

        function buildNewsletter() {
          console.log("Building newsletter, remaining content:", $('#newsletterContent').contents().length);
          var images = $('.question img');
          images.each(function() {
            var $this = $(this);
            if ($this.width() > 200) {
              $this.css({'width': '80%', 'max-width': '200px'});
            }
          });

          adjustTableWidths();
          typesetMathJax();

          if ($('#newsletterContent').contents().length > 0) {
            var $page = $('.page_template:first').clone()
              .addClass('sheet padding-10mm')
              .css({'display': 'block', 'margin': 'auto'});
            $page.find('.footer span').append(page);
            $('body').append($page);
            page++;

            $('#newsletterContent').columnize({
              columns: 2,
              target: '.sheet:last .content',
              ignoreImageLoading: false,
              dontsplit: 'dontsplit',
              overflow: {
                height: content_height,
                id: '#newsletterContent',
                doneFunc: function() {
                  console.log("Page completed, moving to next");
                  adjustTableWidths();
                  typesetMathJax();
                  buildNewsletter();
                }
              }
            });
          } else {
            $('.loader').hide();
            $('#printDiv').show();
            $('#newsletterContent').hide();
            $('#printBtn').click(function() {
              console.log("Print button clicked");
              adjustTableWidths();
              typesetMathJax();
              setTimeout(function() {
                window.print();
              }, 500);
            });
          }
        }

        function fetchSingleJson(metaId) {
          var url = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${metaId}.json`;
          console.log("Fetching JSON:", url);
          return $.getJSON(url)
            .done(function(data) {
              console.log("JSON fetched successfully for", metaId, "Questions:", data.flatMap(s => s.questions || []).length);
              return data;
            })
            .fail(function(jqXHR, textStatus, error) {
              console.error("JSON fetch failed for", metaId, ":", textStatus, error);
              return [];
            });
        }

        function fetchAllJsonsAndSelectQuestions(total) {
          console.log("Fetching all JSONs for", total, "questions");
          var promises = metaIds.map(meta => fetchSingleJson(meta.id));
          $.when.apply($, promises).then(function() {
            var allData = Array.from(arguments).map((result, index) => {
              return result[0] || [];
            });

            // Group questions by subject
            var subjectQuestions = {};
            allData.forEach(data => {
              data.forEach(subjectData => {
                var subject = subjectData.subject || "unknown";
                if (!subjectQuestions[subject]) {
                  subjectQuestions[subject] = [];
                }
                subjectQuestions[subject].push(...(subjectData.questions || []));
              });
            });

            // Calculate questions per subject
            var subjects = Object.keys(subjectQuestions).filter(s => s !== "unknown");
            var questionsPerSubject = Math.floor(total / subjects.length);
            var selectedQuestions = [];

            console.log("Subjects found:", subjects);

            // Randomly select questions for each subject
            subjects.forEach(subject => {
              var questions = subjectQuestions[subject];
              if (questions.length === 0) {
                console.warn("No questions for subject:", subject);
                return;
              }
              var shuffled = shuffleArray([...questions]);
              var numToSelect = Math.min(questionsPerSubject, questions.length);
              selectedQuestions.push(...shuffled.slice(0, numToSelect));
              console.log("Selected", numToSelect, "questions for", subject);
            });

            // Ensure exact total by filling with random questions if needed
            if (selectedQuestions.length < total) {
              var allQuestions = Object.values(subjectQuestions).flat();
              var remaining = total - selectedQuestions.length;
              var shuffledRemaining = shuffleArray([...allQuestions]);
              selectedQuestions.push(...shuffledRemaining.slice(0, remaining));
              console.log("Added", remaining, "additional random questions");
            }

            // Sort by subject for rendering
            var sortedQuestions = [];
            subjects.forEach(subject => {
              var subjectQs = selectedQuestions.filter(q => subjectQuestions[subject].includes(q));
              sortedQuestions.push(...subjectQs);
            });

            console.log("Total selected questions:", sortedQuestions.length);
            renderQuestions(sortedQuestions);
            setTimeout(buildNewsletter, 500);
          }).fail(function() {
            console.error("Failed to fetch some JSONs");
            $('#newsletterContent').append('<div class="error-message">Failed to load questions. Using sample content.</div>');
            renderQuestions(fallbackContent);
            setTimeout(buildNewsletter, 500);
          });
        }

        // Main logic
        console.log("Query parameters - metaId:", selectedMetaId, "total:", totalQuestions);
        $('.loader').show();
        if (totalQuestions === 180) {
          console.log("Generating 180 random questions from all JSONs");
          fetchAllJsonsAndSelectQuestions(totalQuestions);
        } else {
          console.log("Fetching single JSON for metaId:", selectedMetaId);
          fetchSingleJson(selectedMetaId)
            .done(function(data) {
              var questions = data.flatMap(subjectData => subjectData.questions || []);
              console.log("Questions loaded:", questions.length);
              if (questions.length === 0) {
                console.warn("No questions in JSON, using fallback");
                $('#newsletterContent').append('<div class="error-message">No questions found for this meta ID. Using sample content.</div>');
                renderQuestions(fallbackContent);
              } else {
                renderQuestions(questions);
              }
              setTimeout(buildNewsletter, 500);
            })
            .fail(function() {
              console.error("Single JSON fetch failed, using fallback");
              $('#newsletterContent').append('<div class="error-message">Failed to load questions for meta ID. Using sample content.</div>');
              renderQuestions(fallbackContent);
              setTimeout(buildNewsletter, 500);
            });
        }
      });
    </script>
  </head>
  <body class="A4">
    <div class="page_template">
      <div class='header'>
        <!-- Dynamically updated by JavaScript -->
      </div>
      <div class='content'></div>
      <div class='footer'><span>Page: </span></div>
    </div>
    <div class="loader">
      <br><br>
      <div class="spinner"></div>
      <br><br>
      <h2 style="text-align: center;">Generating PDF, please wait...</h2>
    </div>
    <div id="printDiv" class="noprint">
      <button id='printBtn'>Print PDF</button>
    </div>
    <div id="newsletterContent" style="visibility:hidden;display:block;"></div>
  </body>
</html>
