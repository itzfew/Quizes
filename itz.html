<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEET PYQ Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f9f9fb;
    }

    h1 {
      text-align: center;
      margin: 1rem 0;
      color: #2c3e50;
    }

    #setup, #quiz {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }

    input[type="number"] {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      max-width: 200px;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #1976d2;
      color: white;
    }

    button:hover {
      background: #1565c0;
    }

    .hidden {
      display: none;
    }

    #navigation {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      margin: 1em 0;
    }

    #navigation button {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-weight: bold;
      background: #eee;
      color: #333;
    }

    .nav-correct { background: green !important; color: white; }
    .nav-incorrect { background: red !important; color: white; }
    .visited { background: #ccc !important; }

    #question-box {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }

    #source {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
      color: #333;
    }

    .option {
      background: #f1f1f1;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, border 0.3s;
    }

    .option:hover {
      background: #e3f2fd;
    }

    .selected {
      border: 2px solid #1976d2;
      background: #bbdefb;
    }

    .correct {
      background: #c8e6c9 !important;
      border: 2px solid green;
    }

    .incorrect {
      background: #ffcdd2 !important;
      border: 2px solid red;
    }

    #result {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      margin: 1rem;
    }

    #explanation {
      background: #fff3e0;
      border-left: 6px solid #ff9800;
      padding: 10px;
      margin-top: 15px;
      border-radius: 6px;
    }

    @media (max-width: 600px) {
      button {
        font-size: 14px;
        padding: 8px 16px;
      }

      .option {
        font-size: 14px;
        padding: 10px;
      }

      #navigation button {
        width: 30px;
        height: 30px;
      }
    }
  </style>
</head>
<body>
  <h1>NEET PYQ Practice</h1>
  <div id="setup">
    <h2>Enter number of questions:</h2>
    <input type="number" id="numQuestions" min="3" step="1"/>
    <button onclick="startQuiz()">Start</button>
  </div>

  <div id="quiz" class="hidden">
    <div id="navigation"></div>
    <div id="source"></div>
    <div id="question-box"></div>
    <div style="text-align: center;">
      <button onclick="prevQuestion()">Back</button>
      <button onclick="checkAnswer()">Check Answer</button>
      <button onclick="nextQuestion()">Next</button>
    </div>
    <div id="result"></div>
  </div>

  <script>
    const subjects = ['biology', 'chemistry', 'physics'];
    const metaIds = [
      { id: "cbfbed57-d7d8-5a07-9957-478e4cb62f17", title: "NEET 2023" },
      { id: "2ff56f11-0061-566e-aeca-9cc14246e8fb", title: "NEET 2021" },
      { id: "27ba990b-5085-5196-87dd-9727f95fc228", title: "NEET 2020 Phase 1" },
      { id: "c3ae87e9-4094-514a-b2a4-b6e98b1d7ec3", title: "NEET 2019" }
    ];

    let allQuestions = [], quizQuestions = [], currentIndex = 0, answerCache = {}, score = 0;

    async function startQuiz() {
      const count = parseInt(document.getElementById('numQuestions').value);
      if (!count || count < 3) return alert('Enter at least 3 questions.');

      document.getElementById('setup').classList.add('hidden');
      document.getElementById('quiz').classList.remove('hidden');

      for (const meta of metaIds) {
        const url = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${meta.id}.json`;
        const res = await fetch(url);
        const data = await res.json();
        allQuestions.push(...data.flatMap(group =>
          group.questions.map(q => ({ ...q, source: meta.title }))
        ));
      }

      const perSubject = Math.floor(count / 3);
      const remainder = count % 3;
      const subjectDist = [perSubject + (remainder >= 1 ? 1 : 0), perSubject + (remainder >= 2 ? 1 : 0), perSubject];

      for (let i = 0; i < 3; i++) {
        const subjectQs = allQuestions.filter(q => q.subject === subjects[i]);
        const picked = subjectQs.sort(() => 0.5 - Math.random()).slice(0, subjectDist[i]);
        quizQuestions.push(...picked);
      }

      quizQuestions = quizQuestions.map((q, i) => ({ ...q, number: i + 1 }));
      generateNav();
      loadQuestion(0);
    }

    function generateNav() {
      const nav = document.getElementById('navigation');
      nav.innerHTML = '';
      quizQuestions.forEach((q, i) => {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.onclick = () => loadQuestion(i);
        btn.id = `nav-${i}`;
        nav.appendChild(btn);
      });
    }

    function loadQuestion(index) {
      currentIndex = index;
      const q = quizQuestions[index];
      document.getElementById('source').textContent = `Subject: ${q.subject.toUpperCase()} | Source: ${q.source}`;
      const box = document.getElementById('question-box');

      let html = `<h3>${renderMath(q.content)}</h3>`;
      q.options.forEach((opt, i) => {
        html += `<div class="option" data-id="${opt.identifier}" onclick="selectOption('${opt.identifier}')">${String.fromCharCode(65+i)}. ${renderMath(opt.content)}</div>`;
      });
      html += `<div id="explanation" class="hidden">${q.explanation ? "Explanation: " + renderMath(q.explanation) : "No explanation available."}</div>`;
      box.innerHTML = html;

      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

      const saved = localStorage.getItem(`q-${q.question_id}`);
      if (saved) selectOption(saved);
    }

    function selectOption(id) {
      const opts = document.querySelectorAll('.option');
      opts.forEach(o => o.classList.remove('selected'));
      const el = [...opts].find(o => o.dataset.id === id);
      if (el) el.classList.add('selected');
      localStorage.setItem(`q-${quizQuestions[currentIndex].question_id}`, id);
    }

    function checkAnswer() {
      const q = quizQuestions[currentIndex];
      const selected = document.querySelector('.option.selected');
      const correct = q.options.find(opt => opt.is_correct);

      if (!selected) return alert('Please select an option!');

      document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('correct', 'incorrect');
        if (opt.dataset.id === correct.identifier) opt.classList.add('correct');
        if (opt === selected && selected.dataset.id !== correct.identifier) opt.classList.add('incorrect');
      });

      const navBtn = document.getElementById(`nav-${currentIndex}`);
      if (selected.dataset.id === correct.identifier) {
        navBtn.classList.add('nav-correct');
        answerCache[q.question_id] = 4;
      } else {
        navBtn.classList.add('nav-incorrect');
        answerCache[q.question_id] = -1;
      }

      navBtn.classList.add('visited');
      calculateScore();
      document.getElementById('explanation').classList.remove('hidden');
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }

    function nextQuestion() {
      if (currentIndex < quizQuestions.length - 1) loadQuestion(currentIndex + 1);
      else showResult();
    }

    function prevQuestion() {
      if (currentIndex > 0) loadQuestion(currentIndex - 1);
    }

    function calculateScore() {
      const total = quizQuestions.reduce((sum, q) => sum + (answerCache[q.question_id] || 0), 0);
      document.getElementById('result').textContent = `Score: ${total}`;
    }

    function showResult() {
      calculateScore();
      alert('Quiz Complete!');
    }

    function renderMath(str) {
      return str.replace(/\$\$(.*?)\$\$/g, (_, eq) => `<span class="mathjax">$$${eq}$$</span>`);
    }
  </script>
</body>
</html>
