<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Details - Quiz App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            line-height: 1.6;
            color: #333;
            padding: 0;
            margin: 0;
        }
        
        header {
            background-color: #2c3e50;
            color: #fff;
            padding: 15px 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        nav ul li {
            margin: 5px 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 1rem;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        nav ul li a:hover {
            background-color: #34495e;
        }
        
        nav ul li a.active {
            background-color: #3498db;
        }
        
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            min-height: calc(100vh - 150px);
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .container:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        h1, h2, h3, h4 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* Test Summary */
        .test-summary {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .score-display {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .score-correct {
            color: #2ecc71;
        }
        
        .score-incorrect {
            color: #e74c3c;
        }
        
        .score-skipped {
            color: #f39c12;
        }
        
        /* Test Details */
        .result-item {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .result-item.correct {
            border-left: 4px solid #2ecc71;
        }
        
        .result-item.incorrect {
            border-left: 4px solid #e74c3c;
        }
        
        .result-question {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .result-answer {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .user-answer {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .correct-answer {
            font-weight: bold;
            color: #2ecc71;
        }
        
        .result-explanation {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 3px solid #3498db;
        }
        
        /* Navigation Controls */
        .nav-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Subject Badges */
        .subject-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .biology-badge {
            background-color: #2ecc71;
            color: white;
        }
        
        .physics-badge {
            background-color: #9b59b6;
            color: white;
        }
        
        .chemistry-badge {
            background-color: #3498db;
            color: white;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            nav ul li {
                margin: 5px 8px;
            }
            
            nav ul li a {
                font-size: 0.9rem;
                padding: 6px 12px;
            }
            
            .nav-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            nav ul li a {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .result-item {
                padding: 15px;
            }
        }
        
        /* MathJax inline styling */
        .mathjax-inline {
            white-space: nowrap;
            display: inline-block;
            font-size: 1.2em;
            color: #3498db;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="profile.html"><i class="fas fa-chart-line"></i> My Stats</a></li>
                <li id="auth-nav-item"><a href="#" id="auth-nav"><i class="fas fa-user"></i> <span id="auth-text">Login</span></a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="container" id="test-details-container">
            <div id="test-loading" class="spinner"></div>
            
            <div id="test-summary" style="display: none;">
                <h1>Test Details</h1>
                <div class="test-summary">
                    <h2 id="test-title">Test Summary</h2>
                    <div class="score-display">
                        <span>Your Score: </span>
                        <span class="score-correct" id="correct-answers">0</span>
                        <span>/</span>
                        <span id="total-questions">0</span>
                        <span> (</span>
                        <span id="quiz-score">0</span>
                        <span>%)</span>
                    </div>
                    <div class="score-display">
                        <span>Marks: </span>
                        <span class="score-correct" id="marks-obtained">0</span>
                        <span>/</span>
                        <span id="total-marks">0</span>
                    </div>
                    <p>Time Taken: <span id="time-taken">0:00</span></p>
                    <p>Date: <span id="test-date"></span></p>
                    <p>Mode: <span id="test-mode"></span></p>
                    <p>Chapters: <span id="test-chapters"></span></p>
                </div>
                
                <h2>Question-wise Results</h2>
                <div id="detailed-results"></div>
                
                <div class="nav-controls">
                    <button class="btn btn-primary" id="reattempt-btn">
                        <i class="fas fa-redo"></i> Reattempt This Test
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='profile.html'">
                        <i class="fas fa-arrow-left"></i> Back to Profile
                    </button>
                </div>
            </div>
            
            <div class="container" id="login-prompt" style="display: none; text-align: center;">
                <h2>Please Login to View Test Details</h2>
                <p>You need to be logged in to access test details.</p>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">
                    <i class="fas fa-sign-in-alt"></i> Go to Login Page
                </button>
            </div>
        </div>
    </main>

    <script>
        // Firebase configuration (same as in index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDIWtVfoGIWQoRVe36v6g6S3slTRRYUAgk",
            authDomain: "quizes-3028d.firebaseapp.com",
            databaseURL: "https://quizes-3028d-default-rtdb.firebaseio.com",
            projectId: "quizes-3028d",
            storageBucket: "quizes-3028d.appspot.com",
            messagingSenderId: "624591251031",
            appId: "1:624591251031:web:e093472f24fdeb29fc2512",
            measurementId: "G-QMZK5Y6769"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const testDetailsContainer = document.getElementById('test-details-container');
        const testLoading = document.getElementById('test-loading');
        const testSummary = document.getElementById('test-summary');
        const loginPrompt = document.getElementById('login-prompt');
        const correctAnswersSpan = document.getElementById('correct-answers');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const quizScoreSpan = document.getElementById('quiz-score');
        const timeTakenSpan = document.getElementById('time-taken');
        const marksObtainedSpan = document.getElementById('marks-obtained');
        const totalMarksSpan = document.getElementById('total-marks');
        const testDateSpan = document.getElementById('test-date');
        const testModeSpan = document.getElementById('test-mode');
        const testChaptersSpan = document.getElementById('test-chapters');
        const detailedResultsDiv = document.getElementById('detailed-results');
        const reattemptBtn = document.getElementById('reattempt-btn');
        const authText = document.getElementById('auth-text');
        const testTitle = document.getElementById('test-title');

        // Global variables
        let currentUser = null;
        let currentTestId = null;
        let testData = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Get test ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentTestId = urlParams.get('testId');
            const userId = urlParams.get('userId');
            
            // Initialize auth state listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authText.textContent = 'Profile';
                    
                    // Verify the test belongs to the current user
                    if (userId === user.uid) {
                        loadTestDetails(user.uid, currentTestId);
                    } else {
                        showError("You can only view your own test details.");
                    }
                } else {
                    currentUser = null;
                    authText.textContent = 'Login';
                    testSummary.style.display = 'none';
                    loginPrompt.style.display = 'block';
                    testLoading.style.display = 'none';
                }
            });
            
            // Reattempt button click handler
            reattemptBtn.addEventListener('click', reattemptCurrentTest);
        });

        // Load test details from Firebase
        function loadTestDetails(userId, testId) {
            testLoading.style.display = 'block';
            testSummary.style.display = 'none';
            
            database.ref(`userTests/${userId}/${testId}`).once('value')
                .then(snapshot => {
                    testData = snapshot.val();
                    
                    if (!testData) {
                        showError("Test not found.");
                        return;
                    }
                    
                    displayTestDetails();
                })
                .catch(error => {
                    console.error('Error loading test:', error);
                    showError("Error loading test details. Please try again.");
                });
        }

        // Display test details
        function displayTestDetails() {
            // Update summary section
            correctAnswersSpan.textContent = testData.correctAnswers;
            totalQuestionsSpan.textContent = testData.totalQuestions;
            quizScoreSpan.textContent = testData.score;
            marksObtainedSpan.textContent = testData.marksObtained;
            totalMarksSpan.textContent = testData.totalMarks;
            timeTakenSpan.textContent = testData.timeTaken || 'N/A';
            
            // Format date
            const date = new Date(testData.timestamp);
            testDateSpan.textContent = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString();
            
            // Set mode and subject
            testModeSpan.textContent = testData.mode === 'exam' ? 'Exam Mode' : 'Practice Mode';
            
            // Format chapters
            const subjectName = testData.subject.charAt(0).toUpperCase() + testData.subject.slice(1);
            const chapters = testData.chapters ? testData.chapters.join(', ') : 'Multiple chapters';
            testChaptersSpan.textContent = `${subjectName} - ${chapters}`;
            
            // Set test title with subject badge
            const subjectBadgeClass = `${testData.subject}-badge`;
            testTitle.innerHTML = `
                <span class="subject-badge ${subjectBadgeClass}">${subjectName}</span>
                ${testData.mode === 'exam' ? 'Exam' : 'Practice'} Test Results
            `;
            
            // Generate detailed results
            generateDetailedResults();
            
            // Hide loading and show content
            testLoading.style.display = 'none';
            testSummary.style.display = 'block';
        }

        // Generate detailed question results
        function generateDetailedResults() {
            let html = '';
            
            testData.questions.forEach((questionData, index) => {
                const question = questionData;
                const isCorrect = questionData.isCorrect;
                const userAnswer = questionData.userAnswer;
                const correctAnswer = questionData.correctAnswer;
                
                // Find the actual question content from the question data
                const questionContent = question.content || "Question content not available";
                const options = question.options || [];
                
                // Find user and correct options
                const userOption = options.find(opt => opt.identifier === userAnswer);
                const correctOption = options.find(opt => opt.identifier === correctAnswer);
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="result-question">Question ${index + 1}: ${renderMath(questionContent)}</div>
                        
                        <div class="result-answer">
                            <p><span class="user-answer">Your answer:</span> ${
                                userOption
                                    ? String.fromCharCode(65 + options.indexOf(userOption)) + '. ' + renderMath(userOption.content)
                                    : '<span class="score-skipped">Skipped</span>'
                            }</p>
                            <p><span class="correct-answer">Correct answer:</span> ${
                                correctOption
                                    ? String.fromCharCode(65 + options.indexOf(correctOption)) + '. ' + renderMath(correctOption.content)
                                    : 'Unknown'
                            }</p>
                            <p>Marks: ${
                                isCorrect 
                                    ? '<span class="score-correct">+4</span>' 
                                    : userAnswer 
                                        ? '<span class="score-incorrect">-1</span>' 
                                        : '<span class="score-skipped">0</span>'
                            }</p>
                        </div>
                        
                        <div class="result-explanation">
                            <p>${renderMath(question.explanation || 'No explanation available.')}</p>
                        </div>
                    </div>
                `;
            });
            
            detailedResultsDiv.innerHTML = html;
            
            // Render MathJax
            if (window.MathJax) {
                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            }
        }

        // Reattempt the current test
        function reattemptCurrentTest() {
            if (!testData) return;
            
            // Prepare test data for reattempt
            const reattemptData = {
                questions: testData.questions.map(q => ({
                    question_id: q.questionId,
                    content: q.content,
                    options: q.options,
                    correct_options: [q.correctAnswer],
                    explanation: q.explanation,
                    chapter: q.chapter,
                    subject: q.subject
                })),
                subject: testData.subject,
                chapters: testData.chapters,
                mode: testData.mode
            };
            
            // Store in sessionStorage
            sessionStorage.setItem('reattemptTest', JSON.stringify(reattemptData));
            
            // Redirect to index.html
            window.location.href = 'index.html';
        }

        // Show error message
        function showError(message) {
            testLoading.style.display = 'none';
            testSummary.style.display = 'none';
            
            const errorHTML = `
                <div class="container" style="text-align: center;">
                    <h2>Error</h2>
                    <p>${message}</p>
                    <button class="btn btn-secondary" onclick="window.location.href='profile.html'" style="margin-top: 20px;">
                        <i class="fas fa-arrow-left"></i> Back to Profile
                    </button>
                </div>
            `;
            
            testDetailsContainer.innerHTML = errorHTML;
        }

        // Render LaTeX using MathJax
        function renderMath(input) {
            if (!input) return '';
            return input.replace(/\$\$(.*?)\$\$/g, (match, p1) => {
                return `<span class="mathjax-inline">$$${p1}$$</span>`;
            });
        }

        // Make functions available globally
        window.renderMath = renderMath;
    </script>
</body>
</html>
