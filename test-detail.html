<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Details - Quiz App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* (Previous CSS remains exactly the same) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            line-height: 1.6;
            color: #333;
            padding: 0;
            margin: 0;
        }
        
        /* (Rest of the CSS remains exactly the same) */
    </style>
</head>
<body>
    <!-- (HTML structure remains exactly the same) -->
    <header>
        <nav>
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="profile.html"><i class="fas fa-chart-line"></i> My Stats</a></li>
                <li id="auth-nav-item"><a href="#" id="auth-nav"><i class="fas fa-user"></i> <span id="auth-text">Login</span></a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="container" id="test-details-container">
            <!-- (Rest of HTML remains exactly the same) -->
        </div>
    </main>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIWtVfoGIWQoRVe36v6g6S3slTRRYUAgk",
            authDomain: "quizes-3028d.firebaseapp.com",
            databaseURL: "https://quizes-3028d-default-rtdb.firebaseio.com",
            projectId: "quizes-3028d",
            storageBucket: "quizes-3028d.appspot.com",
            messagingSenderId: "624591251031",
            appId: "1:624591251031:web:e093472f24fdeb29fc2512",
            measurementId: "G-QMZK5Y6769"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements and global variables
        const testDetailsContainer = document.getElementById('test-details-container');
        const testLoading = document.getElementById('test-loading');
        const testSummary = document.getElementById('test-summary');
        const loginPrompt = document.getElementById('login-prompt');
        const correctAnswersSpan = document.getElementById('correct-answers');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const quizScoreSpan = document.getElementById('quiz-score');
        const timeTakenSpan = document.getElementById('time-taken');
        const marksObtainedSpan = document.getElementById('marks-obtained');
        const totalMarksSpan = document.getElementById('total-marks');
        const testDateSpan = document.getElementById('test-date');
        const testModeSpan = document.getElementById('test-mode');
        const testChaptersSpan = document.getElementById('test-chapters');
        const detailedResultsDiv = document.getElementById('detailed-results');
        const reattemptBtn = document.getElementById('reattempt-btn');
        const authText = document.getElementById('auth-text');
        const testTitle = document.getElementById('test-title');

        let currentUser = null;
        let currentTestId = null;
        let testData = null;
        const metaIds = [
            "3c48616f-298a-5f69-91d2-bcd59444c455", "cbfbed57-d7d8-5a07-9957-478e4cb62f17", "8dd253c6-09a8-5875-b127-a0c00a165a1b",
            "c7fb1fc7-cb24-58d1-99f5-4ced0111082d", "2ff56f11-0061-566e-aeca-9cc14246e8fb", "27ba990b-5085-5196-87dd-9727f95fc228",
            "c3ae87e9-4094-514a-b2a4-b6e98b1d7ec3", "ce68b80b-fff0-5db8-8d6a-668d729d487a", "57222784-be0a-5653-930c-8ac44c689e21"
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentTestId = urlParams.get('testId');
            const userId = urlParams.get('userId');
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authText.textContent = 'Profile';
                    
                    // Check if this is a reattempt (no userId parameter)
                    if (!userId || userId === user.uid) {
                        loadTestDetails(user.uid, currentTestId);
                    } else {
                        // For reattempts, we'll bypass the ownership check
                        if (sessionStorage.getItem('reattemptTest')) {
                            loadTestDetails(user.uid, currentTestId);
                        } else {
                            showError("You can only view your own test details.");
                        }
                    }
                } else {
                    currentUser = null;
                    authText.textContent = 'Login';
                    testSummary.style.display = 'none';
                    loginPrompt.style.display = 'block';
                    testLoading.style.display = 'none';
                }
            });
            
            reattemptBtn.addEventListener('click', reattemptCurrentTest);
        });

        // Load test details from Firebase
        function loadTestDetails(userId, testId) {
            testLoading.style.display = 'block';
            testSummary.style.display = 'none';
            
            // Check if we have reattempt data in sessionStorage
            const reattemptData = sessionStorage.getItem('reattemptTest');
            if (reattemptData) {
                testData = JSON.parse(reattemptData);
                displayTestDetails();
                return;
            }
            
            database.ref(`userTests/${userId}/${testId}`).once('value')
                .then(snapshot => {
                    testData = snapshot.val();
                    
                    if (!testData) {
                        showError("Test not found.");
                        return;
                    }
                    
                    fetchQuestionDetails(testData);
                })
                .catch(error => {
                    console.error('Error loading test:', error);
                    showError("Error loading test details. Please try again.");
                });
        }

        // Fetch full question details
        async function fetchQuestionDetails(testData) {
            try {
                const enhancedQuestions = [];
                
                for (const questionData of testData.questions) {
                    let foundQuestion = null;
                    
                    for (const metaId of metaIds) {
                        if (foundQuestion) break;
                        
                        try {
                            const response = await fetch(`https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${metaId}.json`);
                            const data = await response.json();
                            
                            for (const subjectData of data) {
                                if (foundQuestion) break;
                                
                                for (const question of subjectData.questions) {
                                    if (question.question_id === questionData.questionId) {
                                        foundQuestion = question;
                                        break;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error(`Error loading metaId ${metaId}:`, error);
                        }
                    }
                    
                    if (foundQuestion) {
                        enhancedQuestions.push({
                            ...questionData,
                            content: foundQuestion.content,
                            options: foundQuestion.options,
                            correct_options: foundQuestion.correct_options,
                            explanation: foundQuestion.explanation,
                            chapter: foundQuestion.chapter,
                            subject: foundQuestion.subject
                        });
                    } else {
                        console.warn(`Question not found: ${questionData.questionId}`);
                        enhancedQuestions.push(questionData);
                    }
                }
                
                testData.questions = enhancedQuestions;
                displayTestDetails();
            } catch (error) {
                console.error('Error fetching question details:', error);
                displayTestDetails();
            }
        }

        // Display test details
        function displayTestDetails() {
            correctAnswersSpan.textContent = testData.correctAnswers || 0;
            totalQuestionsSpan.textContent = testData.totalQuestions || 0;
            quizScoreSpan.textContent = testData.score || 0;
            marksObtainedSpan.textContent = testData.marksObtained || 0;
            totalMarksSpan.textContent = testData.totalMarks || 0;
            timeTakenSpan.textContent = testData.timeTaken || 'N/A';
            
            const date = new Date(testData.timestamp || Date.now());
            testDateSpan.textContent = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString();
            
            testModeSpan.textContent = testData.mode === 'exam' ? 'Exam Mode' : 'Practice Mode';
            
            const subjectName = (testData.subject || 'biology').charAt(0).toUpperCase() + (testData.subject || 'biology').slice(1);
            const chapters = testData.chapters ? testData.chapters.join(', ') : 'Multiple chapters';
            testChaptersSpan.textContent = `${subjectName} - ${chapters}`;
            
            const subjectBadgeClass = `${testData.subject || 'biology'}-badge`;
            testTitle.innerHTML = `
                <span class="subject-badge ${subjectBadgeClass}">${subjectName}</span>
                ${testData.mode === 'exam' ? 'Exam' : 'Practice'} Test Results
            `;
            
            generateDetailedResults();
            testLoading.style.display = 'none';
            testSummary.style.display = 'block';
        }

        // Generate detailed results
        function generateDetailedResults() {
            let html = '';
            
            testData.questions.forEach((questionData, index) => {
                const question = questionData;
                const isCorrect = questionData.isCorrect;
                const userAnswer = questionData.userAnswer;
                const correctAnswer = questionData.correctAnswer || (question.correct_options ? question.correct_options[0] : null);
                
                const questionContent = question.content || "Question content not available";
                const options = question.options || [];
                
                const userOption = options.find(opt => opt.identifier === userAnswer);
                const correctOption = options.find(opt => opt.identifier === correctAnswer);
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="result-question">Question ${index + 1}: ${renderMath(questionContent)}</div>
                        
                        <div class="result-answer">
                            <p><span class="user-answer">Your answer:</span> ${
                                userOption
                                    ? String.fromCharCode(65 + options.indexOf(userOption)) + '. ' + renderMath(userOption.content)
                                    : '<span class="score-skipped">Skipped</span>'
                            }</p>
                            <p><span class="correct-answer">Correct answer:</span> ${
                                correctOption
                                    ? String.fromCharCode(65 + options.indexOf(correctOption)) + '. ' + renderMath(correctOption.content)
                                    : correctAnswer ? correctAnswer : 'Unknown'
                            }</p>
                            <p>Marks: ${
                                isCorrect 
                                    ? '<span class="score-correct">+4</span>' 
                                    : userAnswer 
                                        ? '<span class="score-incorrect">-1</span>' 
                                        : '<span class="score-skipped">0</span>'
                            }</p>
                        </div>
                        
                        ${question.explanation ? `
                        <div class="result-explanation">
                            <p>${renderMath(question.explanation || 'No explanation available.')}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            detailedResultsDiv.innerHTML = html;
            
            if (window.MathJax) {
                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            }
        }

        // Reattempt the current test
        function reattemptCurrentTest() {
            if (!testData) return;
            
            // Prepare test data for reattempt in exam mode
            const reattemptData = {
                questions: testData.questions.map(q => ({
                    question_id: q.questionId,
                    content: q.content,
                    options: q.options,
                    correct_options: q.correct_options || [q.correctAnswer],
                    explanation: q.explanation,
                    chapter: q.chapter,
                    subject: q.subject
                })),
                subject: testData.subject,
                chapters: testData.chapters,
                mode: 'exam', // Force exam mode for reattempt
                originalTestId: currentTestId // Store the original test ID
            };
            
            // Store in sessionStorage
            sessionStorage.setItem('reattemptTest', JSON.stringify(reattemptData));
            
            // Redirect to index.html with reattempt flag
            window.location.href = `index.html?reattempt=true`;
        }

        // Show error message
        function showError(message) {
            testLoading.style.display = 'none';
            testSummary.style.display = 'none';
            
            const errorHTML = `
                <div class="container" style="text-align: center;">
                    <h2>Error</h2>
                    <p>${message}</p>
                    <button class="btn btn-secondary" onclick="window.location.href='profile.html'" style="margin-top: 20px;">
                        <i class="fas fa-arrow-left"></i> Back to Profile
                    </button>
                </div>
            `;
            
            testDetailsContainer.innerHTML = errorHTML;
        }

        // Render LaTeX using MathJax
        function renderMath(input) {
            if (!input) return '';
            return input.replace(/\$\$(.*?)\$\$/g, (match, p1) => {
                return `<span class="mathjax-inline">$$${p1}$$</span>`;
            });
        }

        window.renderMath = renderMath;
    </script>
</body>
</html>
