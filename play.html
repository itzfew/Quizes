<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Detail</title>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="stylesheet" href="style/question.css">
</head>
<body>
    <!-- Back Button to Go to Index Page -->
    <button class="back-btn" onclick="goBack()">Back</button>
    <main>
        <div class="source" id="source"></div>
        <div id="question-detail"></div>
        <div class="timer" id="timer">Time: 2:00</div>
    </main>

    <script>
    let currentMetaId, currentQuestionIndex = 0, questionsData = [];
    let examData = [];

    // Fetch exam data from the JSON file
    async function fetchExamData() {
        const examsUrl = 'https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/exams.json';
        try {
            const response = await fetch(examsUrl);
            examData = await response.json();
            loadQuestionDetail();
        } catch (error) {
            console.error('Error fetching exam data:', error);
        }
    }

    function loadQuestionDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const examGroup = urlParams.get('examGroup'); // Extract exam group
        const examTitle = urlParams.get('examTitle'); // Extract exam title

        // Find the correct paper based on the exam group and title
        const exam = examData.find(exam => exam.title === examGroup);
        if (exam) {
            const paper = exam.papers.find(paper => paper.title === examTitle);
            if (paper) {
                currentMetaId = paper.metaId;
                document.getElementById('source').textContent = `Source: ${paper.title} (${paper.year})`;
                fetchQuestions(currentMetaId);
            } else {
                document.getElementById('question-detail').innerHTML = '<p>Invalid exam paper.</p>';
            }
        } else {
            document.getElementById('question-detail').innerHTML = '<p>Invalid exam group.</p>';
        }
    }

    // Fetch questions from a JSON file
    async function fetchQuestions(metaId) {
        const chaptersUrl = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${metaId}.json`;

        try {
            const response = await fetch(chaptersUrl);
            const data = await response.json();
            // Assuming questions are within each subject (chapter), iterate through them all
            questionsData = data.flatMap(subject => subject.questions); // Combine all questions from all subjects

            if (questionsData.length > 0 && currentQuestionIndex < questionsData.length) {
                renderQuestionDetail(questionsData[currentQuestionIndex]);
                startTimer();
            } else {
                document.getElementById('question-detail').innerHTML = '<p>No questions found for this Meta ID or invalid question index.</p>';
            }
        } catch (error) {
            console.error('Error fetching question data:', error);
        }
    }

    function renderQuestionDetail(question) {
        let questionDetailHTML = `
            <h3>${renderMath(question.content)}</h3>
            <ul class="options">
                ${question.options.map((opt, index) => 
                    `<li data-option="${opt.identifier}" id="option${index}">
                        ${String.fromCharCode(65 + index)}. ${renderMath(opt.content)}
                    </li>`
                ).join('')}
            </ul>
            <button class="check-btn" onclick="checkAnswer()">Check Answer</button>
            <button id="next-btn" onclick="loadNextQuestion()">Next Question</button>
            <div class="explanation" id="explanation">
                <h4>Explanation:</h4>
                <p>${renderMath(question.explanation)}</p>
            </div>
        `;
        document.getElementById('question-detail').innerHTML = questionDetailHTML;

        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

        // Attach event listeners to options
        const options = document.querySelectorAll('.options li');
        options.forEach(option => {
            option.addEventListener('click', function () {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                saveAnswer(option.dataset.option);
            });
        });

        // Check for saved answer in localStorage
        const savedAnswer = localStorage.getItem(`answer-${currentMetaId}-${currentQuestionIndex}`);
        if (savedAnswer) {
            document.querySelector(`#option${savedAnswer}`).classList.add('selected');
        }
    }

    // Render LaTeX using MathJax
    function renderMath(input) {
        return input.replace(/\$\$(.*?)\$\$/g, (match, p1) => {
            return `<span class="mathjax-inline">$$${p1}$$</span>`;
        });
    }

    // Save selected answer to localStorage
    function saveAnswer(optionId) {
        localStorage.setItem(`answer-${currentMetaId}-${currentQuestionIndex}`, optionId);
    }

    // Check and display the correct answer
    function checkAnswer() {
        const selectedOption = document.querySelector('.options li.selected');
        if (!selectedOption) {
            alert("Please select an option.");
            return;
        }

        const correctAnswer = getCorrectAnswer(currentMetaId, currentQuestionIndex);
        const options = document.querySelectorAll('.options li');

        options.forEach(option => {
            option.classList.remove('correct', 'incorrect');
            if (option.dataset.option === correctAnswer) {
                option.classList.add('correct');
            } else if (option === selectedOption) {
                option.classList.add('incorrect');
            }
        });

        // Show explanation after checking the answer
        document.getElementById('explanation').style.display = 'block';
    }

    // Get correct answer based on the question ID (example logic)
    function getCorrectAnswer(metaId, questionIndex) {
        return 'A'; // Placeholder for correct answer, adjust according to actual data
    }

    // Load next question and update URL
    function loadNextQuestion() {
        const selectedOption = document.querySelector('.options li.selected');

        if (!selectedOption) {
            alert("You need to select an answer before proceeding.");
            return;
        }

        // Check the answer before proceeding to the next question
        checkAnswer();

        // Increment question index
        currentQuestionIndex++;

        // If we are at the last question, reset to first question or end the quiz
        if (currentQuestionIndex >= questionsData.length) {
            currentQuestionIndex = 0; // Reset to first question, or show quiz completion
        }

        const newUrl = `?title=${examGroup}&examGroup=${examGroup}&examTitle=${examTitle}&metaId=${currentMetaId}&index=${currentQuestionIndex + 1}`;
        window.history.pushState({ path: newUrl }, '', newUrl);

        // Load the next question
        loadQuestionDetail();
    }

    // Load the question detail on page load
    window.onload = fetchExamData;

    // Handle back button navigation
    function goBack() {
        const currentUrl = window.location.href;
        const urlParams = new URLSearchParams(window.location.search);
        const examGroup = urlParams.get('examGroup');
        const examTitle = urlParams.get('examTitle');

        if (examGroup && examTitle) {
            const exam = examData.find(exam => exam.title === examGroup);
            if (exam) {
                const paper = exam.papers.find(paper => paper.title === examTitle);
                if (paper) {
                    const newUrl = `subject.html?examGroup=${examGroup}&examTitle=${examTitle}`;
                    window.location.href = newUrl;
                }
            }
        } else {
            console.error('No valid parameters found in the URL.');
        }
    }
    </script>

</body>
</html>
