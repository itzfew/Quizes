<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Detail</title>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="stylesheet" href="style/question.css">
</head>
<body>
    <!-- Back Button to Go to Index Page -->
    <button class="back-btn" onclick="goBack()">Back</button>
    <main>
        <div class="source" id="source"></div>
        <div id="question-detail"></div>
        <div class="timer" id="timer">Time: 2:00</div>
    </main>

    <script>
        let currentMetaId, currentQuestionIndex = 0, questionsData = [];
        let metaData = []; // Declare the metaData array

        // Fetch the meta data from the provided exams.json
        async function fetchMetaIds() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/exams.json'); // Adjust path
                const data = await response.json();
                metaData = data; // Store the fetched data

                loadQuestionDetail();
            } catch (error) {
                console.error('Error fetching metaIds:', error);
            }
        }

        // Load question details based on the URL parameters
        function loadQuestionDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            currentMetaId = urlParams.get('metaId'); // Extract metaId from URL
            const index = parseInt(urlParams.get('index'), 10); // Extract index

            // Find the correct paper based on metaId
            let selectedPaper;
            metaData.forEach(exam => {
                const paper = exam.papers.find(paper => paper.metaId === currentMetaId);
                if (paper) {
                    selectedPaper = paper;
                }
            });

            if (selectedPaper) {
                document.getElementById('source').textContent = `Source: ${selectedPaper.title}`;
                fetchQuestions(selectedPaper.metaId, index); // Pass index
            } else {
                document.getElementById('question-detail').innerHTML = '<p>Invalid Meta ID.</p>';
            }
        }

// Fetch the questions from the specified metaId
async function fetchQuestions(metaId, index) {
    const chaptersUrl = `https://raw.githubusercontent.com/itzfew/Quizes/refs/heads/main/pyq/${metaId}.json`;

    try {
        const response = await fetch(chaptersUrl);
        const data = await response.json();
        questionsData = data.flatMap(subject => subject.questions); // Flatten the data

        // Adjust index to start from 1 (user perspective)
        currentQuestionIndex = (index && index > 0) ? index - 1 : 0;

        if (questionsData.length > 0 && currentQuestionIndex < questionsData.length) {
            renderQuestionDetail(questionsData[currentQuestionIndex]);
            startTimer();
        } else {
            document.getElementById('question-detail').innerHTML = '<p>No questions found for this Meta ID or invalid question index.</p>';
        }
    } catch (error) {
        console.error('Error fetching question data:', error);
    }
}

// Get correct answer based on the question ID (example logic)
function getCorrectAnswer(metaId, questionIndex) {
    const question = questionsData[questionIndex];
    return question.correct_options; // This should match the field in your JSON
}

// Render question details and options
function renderQuestionDetail(question) {
    let questionDetailHTML = `
        <h3>${renderMath(question.content)}</h3>
        <ul class="options">
            ${question.options.map((opt, index) => 
                `<li data-option="${opt.identifier}" id="option${index}">
                    ${String.fromCharCode(65 + index)}. ${renderMath(opt.content)}
                </li>`
            ).join('')}
        </ul>
        <button class="check-btn" onclick="checkAnswer()">Check Answer</button>
        <button id="next-btn" onclick="loadNextQuestion()">Next Question</button>
        <div class="explanation" id="explanation">
            <h4>Explanation:</h4>
            <p>${renderMath(question.explanation)}</p>
        </div>
    `;
    document.getElementById('question-detail').innerHTML = questionDetailHTML;

    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

    // Attach event listeners to options
    const options = document.querySelectorAll('.options li');
    options.forEach(option => {
        option.addEventListener('click', function () {
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            saveAnswer(option.dataset.option);
        });
    });

    // Check for saved answer in localStorage
    const savedAnswer = localStorage.getItem(`answer-${currentMetaId}-${currentQuestionIndex}`);
    if (savedAnswer) {
        document.querySelector(`#option${savedAnswer}`).classList.add('selected');
    }
}

// Check and display the correct answer
function checkAnswer() {
    const selectedOption = document.querySelector('.options li.selected');
    if (!selectedOption) {
        alert("Please select an option.");
        return;
    }

    const correctAnswer = getCorrectAnswer(currentMetaId, currentQuestionIndex); // Get correct answer from JSON
    const options = document.querySelectorAll('.options li');

    options.forEach(option => {
        option.classList.remove('correct', 'incorrect');
        if (option.dataset.option === correctAnswer) {
            option.classList.add('correct');
        } else if (option === selectedOption) {
            option.classList.add('incorrect');
        }
    });

    // Show explanation after checking the answer
    document.getElementById('explanation').style.display = 'block';
}


        // Load next question and update URL
        function loadNextQuestion() {
            currentQuestionIndex++;

            if (currentQuestionIndex >= questionsData.length) {
                currentQuestionIndex = 0; // Reset to first question, or show quiz completion
            }

            const newUrl = `?metaId=${currentMetaId}&index=${currentQuestionIndex + 1}`;
            window.history.pushState({ path: newUrl }, '', newUrl);

            renderQuestionDetail(questionsData[currentQuestionIndex]);
        }

        // Handle back button navigation
function goBack() {
    window.location.href = "index";
}
        // Load metaIds JSON on page load
        window.onload = fetchMetaIds;
    </script>
</body>
</html>
